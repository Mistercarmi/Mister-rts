// Application principale - RTS Medieval
class RTSMedieval {
    constructor() {
        this.initialized = false;
        this.isOnline = navigator.onLine;
        this.isMobile = this.detectMobile();
        this.touchSupported = 'ontouchstart' in window;
    }

    // D√©tecter si c'est un appareil mobile
    detectMobile() {
        const userAgent = navigator.userAgent;
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
    }

    // Initialiser l'application
    init() {
        if (this.initialized) return;

        console.log('üè∞ Initialisation de RTS Medieval...');
        
        // V√©rifier les pr√©requis
        if (!this.checkSupport()) {
            this.showUnsupportedBrowser();
            return;
        }

        // Configurer l'environnement
        this.setupEnvironment();
        
        // Enregistrer le service worker
        this.registerServiceWorker();
        
        // Initialiser l'interface
        ui.init();
        
        // Configurer les √©v√©nements globaux
        this.setupGlobalEvents();
        
        // Tentative de chargement automatique
        this.tryAutoLoad();
        
        this.initialized = true;
        console.log('‚úÖ RTS Medieval initialis√© avec succ√®s !');
    }

    // V√©rifier le support du navigateur
    checkSupport() {
        // V√©rifier localStorage
        if (typeof Storage === 'undefined') {
            console.error('‚ùå LocalStorage non support√©');
            return false;
        }

        // V√©rifier JSON
        if (typeof JSON === 'undefined') {
            console.error('‚ùå JSON non support√©');
            return false;
        }

        // V√©rifier les fonctions ES6 de base
        try {
            eval('const test = () => {}');
        } catch (e) {
            console.error('‚ùå ES6 non support√©');
            return false;
        }

        return true;
    }

    // Configurer l'environnement
    setupEnvironment() {
        // Configuration mobile
        if (this.isMobile) {
            this.configureMobile();
        }

        // Configuration offline
        if (!this.isOnline) {
            this.configureOffline();
        }

        // Configuration des performances
        this.configurePerformance();
    }

    // Configuration mobile
    configureMobile() {
        console.log('üì± Configuration mobile activ√©e');
        
        // Pr√©venir le zoom
        const viewport = document.querySelector('meta[name="viewport"]');
        if (viewport) {
            viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover';
        }

        // Pr√©venir le scroll bounce
        document.body.style.position = 'fixed';
        document.body.style.width = '100%';
        document.body.style.height = '100%';
        document.body.style.overflow = 'hidden';

        // Am√©liorer les performances tactiles
        document.body.style.touchAction = 'manipulation';
        document.body.style.webkitTouchCallout = 'none';
        document.body.style.webkitUserSelect = 'none';

        // G√©rer l'orientation
        this.handleOrientationChange();
    }

    // Configuration offline
    configureOffline() {
        console.log('üîå Mode hors ligne activ√©');
        ui.showNotification('Mode hors ligne - Vos parties seront sauvegard√©es localement', 'info');
    }

    // Configuration des performances
    configurePerformance() {
        // Optimiser les animations
        if (this.isMobile) {
            // R√©duire les animations sur mobile
            document.documentElement.style.setProperty('--animation-duration', '0.2s');
        }

        // Pr√©venir les fuites m√©moire
        this.setupMemoryManagement();
    }

    // G√©rer les changements d'orientation
    handleOrientationChange() {
        const handleChange = () => {
            setTimeout(() => {
                // Forcer un redimensionnement
                window.dispatchEvent(new Event('resize'));
                
                // Recommander le mode paysage
                if (window.innerHeight > window.innerWidth) {
                    ui.showNotification('üí° Tournez votre appareil en mode paysage pour une meilleure exp√©rience', 'info');
                }
            }, 100);
        };

        window.addEventListener('orientationchange', handleChange);
        window.addEventListener('resize', handleChange);
    }

    // Enregistrer le service worker
    registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('‚úÖ Service Worker enregistr√©:', registration);
                })
                .catch(error => {
                    console.log('‚ùå Erreur Service Worker:', error);
                });
        }
    }

    // Configurer les √©v√©nements globaux
    setupGlobalEvents() {
        // Gestion des erreurs
        window.addEventListener('error', (event) => {
            console.error('‚ùå Erreur JavaScript:', event.error);
            this.handleError(event.error);
        });

        // Gestion des promesses rejet√©es
        window.addEventListener('unhandledrejection', (event) => {
            console.error('‚ùå Promesse rejet√©e:', event.reason);
            this.handleError(event.reason);
        });

        // Gestion de la connexion
        window.addEventListener('online', () => {
            this.isOnline = true;
            ui.showNotification('‚úÖ Connexion r√©tablie', 'success');
        });

        window.addEventListener('offline', () => {
            this.isOnline = false;
            ui.showNotification('üì° Connexion perdue - Mode hors ligne activ√©', 'info');
        });

        // Gestion de la visibilit√©
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.handlePageHidden();
            } else {
                this.handlePageVisible();
            }
        });

        // Gestion des touches
        document.addEventListener('keydown', (event) => {
            this.handleKeypress(event);
        });

        // Pr√©venir le menu contextuel sur mobile
        if (this.isMobile) {
            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });
        }
    }

    // G√©rer les erreurs
    handleError(error) {
        // Sauvegarder l'√©tat en cas d'erreur
        if (gameLogic && gameLogic.getGameState()) {
            gameLogic.saveGame();
        }

        // Afficher une notification d'erreur
        ui.showNotification('Une erreur est survenue. Votre partie a √©t√© sauvegard√©e.', 'error');
    }

    // G√©rer la page cach√©e
    handlePageHidden() {
        console.log('üì± Application mise en arri√®re-plan');
        
        // Sauvegarder automatiquement
        if (gameLogic && gameLogic.getGameState()) {
            gameLogic.saveGame();
        }
        
        // Mettre en pause si en cours
        if (gameLogic && gameLogic.getGameMode() === 'playing') {
            gameLogic.pauseGame();
        }
    }

    // G√©rer la page visible
    handlePageVisible() {
        console.log('üì± Application remise au premier plan');
        
        // Reprendre si n√©cessaire
        if (gameLogic && gameLogic.getGameMode() === 'paused') {
            setTimeout(() => {
                if (confirm('Reprendre la partie ?')) {
                    gameLogic.pauseGame();
                }
            }, 500);
        }
    }

    // G√©rer les touches
    handleKeypress(event) {
        // Raccourcis clavier
        if (event.ctrlKey || event.metaKey) {
            switch (event.key) {
                case 's':
                    event.preventDefault();
                    if (gameLogic && gameLogic.getGameState()) {
                        gameLogic.saveGame();
                        ui.showNotification('Partie sauvegard√©e', 'success');
                    }
                    break;
                case 'r':
                    event.preventDefault();
                    if (confirm('Red√©marrer la partie ?')) {
                        location.reload();
                    }
                    break;
            }
        }

        // Touches de jeu
        switch (event.key) {
            case 'Escape':
                if (gameLogic && gameLogic.getGameState()) {
                    gameLogic.pauseGame();
                }
                break;
            case ' ':
                event.preventDefault();
                if (gameLogic && gameLogic.getGameState()) {
                    gameLogic.pauseGame();
                }
                break;
        }
    }

    // Tentative de chargement automatique
    tryAutoLoad() {
        const savedGame = localStorage.getItem('rts_medieval_save');
        if (savedGame) {
            console.log('üíæ Partie sauvegard√©e trouv√©e');
            // L'interface se chargera de proposer le chargement
        }
    }

    // Configurer la gestion m√©moire
    setupMemoryManagement() {
        // Nettoyer les intervalles et timeouts orphelins
        setInterval(() => {
            // Forcer le garbage collection si possible
            if (window.gc) {
                window.gc();
            }
        }, 60000); // Toutes les minutes
    }

    // Afficher message navigateur non support√©
    showUnsupportedBrowser() {
        document.body.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: Arial, sans-serif; text-align: center;">
                <div style="background: white; color: #333; padding: 40px; border-radius: 20px; max-width: 400px;">
                    <h1>üè∞ RTS Medieval</h1>
                    <p>Votre navigateur n'est pas support√©.</p>
                    <p>Veuillez utiliser :</p>
                    <ul style="text-align: left; margin: 20px 0;">
                        <li>Safari sur iOS</li>
                        <li>Chrome sur Android</li>
                        <li>Chrome, Firefox, Safari sur ordinateur</li>
                    </ul>
                    <button onclick="location.reload()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer;">
                        R√©essayer
                    </button>
                </div>
            </div>
        `;
    }

    // Obtenir les informations syst√®me
    getSystemInfo() {
        return {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            online: navigator.onLine,
            mobile: this.isMobile,
            touchSupported: this.touchSupported,
            screenSize: `${window.screen.width}x${window.screen.height}`,
            viewportSize: `${window.innerWidth}x${window.innerHeight}`,
            devicePixelRatio: window.devicePixelRatio,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
        };
    }

    // Debug - Afficher les informations syst√®me
    debugInfo() {
        console.table(this.getSystemInfo());
    }
}

// Initialiser l'application quand le DOM est pr√™t
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ DOM pr√™t, initialisation de RTS Medieval...');
    
    // Cr√©er l'instance de l'application
    window.app = new RTSMedieval();
    
    // Initialiser
    app.init();
    
    // Debug en d√©veloppement
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.log('üîß Mode d√©veloppement activ√©');
        window.debug = () => app.debugInfo();
        window.gameLogic = gameLogic;
        window.ui = ui;
    }
});

// Gestion des erreurs globales
window.addEventListener('error', (event) => {
    console.error('üí• Erreur globale:', event.error);
});

// Message de bienvenue
console.log(`
üè∞ RTS Medieval - Jeu de Strat√©gie en Temps R√©el
üì± Optimis√© pour iPhone et Android
üéÆ Jouable directement depuis GitHub Pages
‚öîÔ∏è Que la bataille commence !
`);